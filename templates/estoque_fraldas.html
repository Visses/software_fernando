{% extends "index.html" %}

{% block title %}
Estoque Fraldas
{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/css/estoque.css">

<div class="controle-estoque">
  <h3>Controle de Fraldas</h3>

  <!-- MÃ©dia mensal de fraldas usadas -->
  <h4>MÃ©dia Mensal de Fraldas Usadas</h4>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>MÃªs</th>
          <th>Total Usado</th>
          <th>Total Estoque</th>
        </tr>
      </thead>
      <tbody>
        {% for m in media_mensal %}
          <tr>
            <td>{{ m.mes }}</td>
            <td>{{ m.total_usado }}</td>
            <td>{{ total_estoque }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- FormulÃ¡rio de cadastro -->
  <form id="formFraldas">
    <input type="text" name="tamanho" placeholder="Tamanho" required>
    <input type="text" name="marca" placeholder="Marca" required>
    <input type="number" name="quantidade" placeholder="Quantidade" required>
    <button type="submit">Cadastrar</button>
  </form>

  <!-- Tabela de estoque -->
  <h4>Estoque Atual</h4>
  <div class="table-wrapper">
    <table id="tabelaEstoque">
      <thead>
        <tr>
          <th>Tamanho</th>
          <th>Marca</th>
          <th>Quantidade</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody>
        {% for f in fraldas %}
          <tr>
            <td>{{ f.tamanho }}</td>
            <td>{{ f.marca }}</td>
            <td>{{ f.quantidade }}</td>
            <td>
              <button onclick="alterarQuantidade({{ f.id }}, 'aumentar')">+</button>
              <button onclick="alterarQuantidade({{ f.id }}, 'reduzir')">-</button>
              <button onclick="excluirFralda({{ f.id }})">Excluir</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Tabela de log com mÃ©dia mensal -->
  <h4>HistÃ³rico de AlteraÃ§Ãµes</h4>
  <div class="table-wrapper">
    <table id="tabelaLog">
      <thead>
        <tr>
          <th>Fralda</th>
          <th>AÃ§Ã£o</th>
          <th>Quantidade</th>
          <th>Data/Hora</th>
          <th>Excluir</th>
        </tr>
      </thead>
      <tbody>
        {% for l in log %}
          <tr>
            <td>{{ l.tamanho }} - {{ l.marca }}</td>
            <td>{{ l.acao }}</td>
            <td>{{ l.quantidade }}</td>
            <td>{{ l.data_hora }}</td>
            <td><button onclick="excluirLog({{ l.id }})">ðŸ—‘</button></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Cadastro de fraldas
  document.getElementById("formFraldas").addEventListener("submit", async function(e){
    e.preventDefault();
    let tamanho = this.tamanho.value;
    let marca = this.marca.value;
    let quantidade = parseInt(this.quantidade.value);

    const res = await fetch("/cadastrar_fralda", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({tamanho, marca, quantidade})
    });
    const data = await res.json();
    if(data.success) location.reload();
    else alert("Erro ao cadastrar fralda!");
  });
});

// Alterar quantidade
async function alterarQuantidade(id, acao) {
  let valor = prompt(`Digite a quantidade para ${acao}:`);
  if (!valor || isNaN(valor)) return alert("Valor invÃ¡lido");

  const res = await fetch("/alterar_estoque_fralda", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({id, acao, quantidade: parseInt(valor)})
  });
  const data = await res.json();
  if (data.success) location.reload();
}

// Excluir fralda
async function excluirFralda(id) {
  if (!confirm("Deseja realmente excluir esta fralda?")) return;
  const res = await fetch("/excluir_fralda", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({id})
  });
  const data = await res.json();
  if (data.success) location.reload();
}

// Excluir log com senha
async function excluirLog(id) {
  const senha = prompt("Digite a senha para excluir o log:");
  const res = await fetch("/excluir_log_fralda", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({id, senha})
  });
  const data = await res.json();
  if (data.success) location.reload();
  else alert(data.message);
}
</script>

{% endblock %}
