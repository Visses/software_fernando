{% extends "index.html" %}

{% block title %}
  Estoque EPI
{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/css/estoque.css">
<div class="controle-estoque">
  <h3>Controle de EPI</h3>

  <!-- FormulÃ¡rio de cadastro -->
  <form id="formEPI">
    <input type="text" name="nome" placeholder="Nome do EPI" required>
    <input type="text" name="tamanho" placeholder="Tamanho">
    <input type="number" name="quantidade" placeholder="Quantidade" required>
    <button type="submit">Cadastrar</button>
  </form>

  <!-- Tabela de estoque -->
  <div class="table-wrapper">
  <table id="tabelaEstoque">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Tamanho</th>
        <th>Quantidade</th>
        <th>AÃ§Ãµes</th>
      </tr>
    </thead>
    <tbody>
      {% for i in itens %}
        <tr>
          <td>{{ i.nome }}</td>
          <td>{{ i.tamanho }}</td>
          <td>{{ i.quantidade }}</td>
          <td>
            <button onclick="alterarQuantidade({{ i.id }}, 'aumentar')">+</button>
            <button onclick="alterarQuantidade({{ i.id }}, 'reduzir')">-</button>
            <button onclick="excluirItem({{ i.id }})">Excluir</button>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

  <!-- Tabela de log -->
  <h4>HistÃ³rico de AlteraÃ§Ãµes</h4>
  <div class="table-wrapper">
  <table id="tabelaLog">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Tamanho</th>
        <th>AÃ§Ã£o</th>
        <th>Quantidade</th>
        <th>Data/Hora</th>
        <th>Excluir</th>
      </tr>
    </thead>
    <tbody>
      {% for l in log %}
        <tr>
          <td>{{ l.nome }}</td>
          <td>{{ l.tamanho }}</td>
          <td>{{ l.acao }}</td>
          <td>{{ l.quantidade }}</td>
          <td>{{ l.data_hora }}</td>
          <td><button onclick="excluirLog({{ l.id }})">ðŸ—‘</button></td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
</div>

<script>
document.getElementById("formEPI").addEventListener("submit", async function(e){
  e.preventDefault();
  let nome = this.nome.value;
  let tamanho = this.tamanho.value;
  let quantidade = parseInt(this.quantidade.value);

  const res = await fetch("/cadastrar_epi", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({nome, tamanho, quantidade})
  });
  const data = await res.json();
  if(data.success) location.reload();
});

async function alterarQuantidade(id, acao) {
  let valor = prompt(`Digite a quantidade para ${acao}:`);
  if(!valor || isNaN(valor)) return alert("Valor invÃ¡lido");

  const res = await fetch("/alterar_estoque_epi", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({id, acao, quantidade: parseInt(valor)})
  });
  const data = await res.json();
  if(data.success) location.reload();
}

async function excluirItem(id) {
  if(!confirm("Deseja realmente excluir este item?")) return;
  const res = await fetch("/excluir_epi", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({id})
  });
  const data = await res.json();
  if(data.success) location.reload();
}

async function excluirLog(id) {
  const senha = prompt("Digite a senha para excluir o log:");
  const res = await fetch("/excluir_log_epi", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({id, senha})
  });
  const data = await res.json();
  if(data.success) location.reload();
  else alert(data.message);
}
</script>
{% endblock %}
